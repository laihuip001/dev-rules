"""
Markdownæ—¥è¨˜ãƒ©ã‚¤ã‚¿ãƒ¼

è¦ç´„çµæœã‚’Markdownå½¢å¼ã®æ—¥è¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã€‚
"""

from datetime import datetime
from pathlib import Path


DIARY_TEMPLATE = """# é–‹ç™ºæ—¥è¨˜: {date}

## ğŸ“ Summary

{summary}

---

## ğŸ“ File Changes

{file_changes}

---

## ğŸ¯ Decisions

{decisions}

---

## ğŸ’¡ Learnings

{learnings}

---

## â¡ï¸ Next Steps

{next_steps}

---

*Generated by dev-diary tool*
"""


def write_diary(
    summary: dict,
    output_dir: str | Path,
    date: datetime | None = None
) -> Path:
    """
    æ—¥è¨˜Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›
    
    Args:
        summary: summarizer.pyã‹ã‚‰å–å¾—ã—ãŸDiarySummary
        output_dir: å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        date: æ—¥ä»˜ï¼ˆNoneã®å ´åˆã¯ä»Šæ—¥ï¼‰
        
    Returns:
        ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    """
    output_dir = Path(output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)
    
    date = date or datetime.now()
    filename = date.strftime("%Y-%m-%d.md")
    filepath = output_dir / filename
    
    content = DIARY_TEMPLATE.format(
        date=date.strftime("%Y-%m-%d (%a)"),
        summary=summary.get("summary", "No summary available"),
        file_changes=_format_list(summary.get("file_changes", [])),
        decisions=_format_list(summary.get("decisions", [])),
        learnings=_format_list(summary.get("learnings", [])),
        next_steps=_format_list(summary.get("next_steps", []))
    )
    
    filepath.write_text(content, encoding="utf-8")
    return filepath


def _format_list(items: list[str]) -> str:
    """ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆã«å¤‰æ›"""
    if not items:
        return "- (None)"
    return "\n".join(f"- {item}" for item in items)
